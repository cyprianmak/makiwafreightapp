<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="MakiwaFreight - A marketplace where shippers meet transporters" />
  <meta name="author" content="MakiwaFreight Team" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';" />
  <title>MakiwaFreight App (Plug & Play)</title>
  <style>
    :root{--bg:#0b1220;--panel:#121a2b;--panel-2:#1b2742;--text:#d7e7ff;--muted:#8fb7ff;--accent:#4da3ff;--accent-2:#73c1ff;--good:#22c55e;--warn:#f59e0b;--bad:#ef4444;--border:#2a3b5f;--chip:#0e1a33}*{box-sizing:border-box}html,body{height:100%}body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(180deg,var(--bg),#0d1426 40%,#0a1120);color:var(--text)}a{color:var(--accent)}.container{max-width:1100px;margin:0 auto;padding:24px}header{position:sticky;top:0;z-index:10;background:rgba(11,18,32,0.8);backdrop-filter:blur(8px);border-bottom:1px solid var(--border)}.nav{display:flex;gap:12px;align-items:center;justify-content:space-between}.brand{display:flex;gap:12px;align-items:center}.logo{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:grid;place-items:center;font-weight:800;color:#08203a}.brand h1{font-size:18px;margin:0;color:var(--text)}.auth-area{display:flex;gap:8px;align-items:center}.nav-links{display:flex;gap:8px;flex-wrap:wrap}button,.btn{border:1px solid var(--border);background:linear-gradient(180deg,var(--panel),var(--panel-2));color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:600;transition:all .15s ease;text-decoration:none;display:inline-flex;align-items:center;gap:8px}button:hover,.btn:hover{transform:translateY(-1px);border-color:var(--accent)}.btn.ghost{background:transparent}.btn.primary{background:linear-gradient(180deg,var(--accent),var(--accent-2));color:#0a1a2e;border-color:transparent}.grid{display:grid;gap:16px}.two{grid-template-columns:repeat(2,minmax(0,1fr))}.three{grid-template-columns:repeat(3,minmax(0,1fr))}@media (max-width:900px){.two,.three{grid-template-columns:1fr}}.card{border:1px solid var(--border);border-radius:16px;padding:16px;background:linear-gradient(180deg,var(--panel),var(--panel-2));box-shadow:0 10px 30px rgba(0,0,0,0.25)}.card h3{margin:0 0 8px}.muted{color:var(--muted)}.kpi{display:flex;gap:14px;align-items:center}.chip{background:var(--chip);border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:12px}.danger{color:var(--bad)}.success{color:var(--good)}.warn{color:var(--warn)}.hidden{display:none !important}input,select,textarea{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#0c1530;color:var(--text)}label{font-size:12px;color:var(--muted)}form .grid{margin-top:8px}table{width:100%;border-collapse:separate;border-spacing:0 8px}th,td{padding:10px 12px;border-top:1px solid var(--border);border-bottom:1px solid var(--border)}th{font-weight:700;text-align:left;color:var(--muted);background:#0f1940}tr td:first-child,tr th:first-child{border-left:1px solid var(--border);border-top-left-radius:12px;border-bottom-left-radius:12px}tr td:last-child,tr th:last-child{border-right:1px solid var(--border);border-top-right-radius:12px;border-bottom-right-radius:12px}.toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}.banner{border:1px dashed var(--border);padding:10px 14px;border-radius:12px;background:#0d1836;color:var(--muted)}.footer{opacity:.75;font-size:12px;text-align:center;padding:24px}.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}.checkbox-group{display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:10px;margin-top:10px}.checkbox-item{display:flex;align-items:center;gap:8px}.checkbox-item input{width:auto}.expired{opacity:0.6; text-decoration: line-through;}.profile-header{display:flex;align-items:center;gap:16px;margin-bottom:16px}.profile-avatar{width:80px;height:80px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-size:24px;font-weight:800;color:#08203a}.profile-info h2{margin:0 0 4px}.profile-info .muted{margin:0}.status-indicator{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:6px}.status-active{background-color:var(--good)}.status-inactive{background-color:var(--bad)}
  </style>
</head>
<body>
  <header>
    <div class="container nav">
      <div class="brand">
        <div class="logo" aria-label="MakiwaFreight Logo">MF</div>
        <h1>MakiwaFreight</h1>
        <span id="roleChip" class="chip hidden" role="status" aria-live="polite"></span>
      </div>
      <div class="auth-area">
        <div id="navLinks" class="nav-links"></div>
        <span id="authUser" class="muted"></span>
        <a id="btnLoginNav" href="#login" class="btn" aria-label="Login to your account">Login</a>
        <button id="btnLogout" class="btn ghost hidden" aria-label="Logout from your account">Logout</button>
      </div>
    </div>
  </header>
  <main class="container">
    <!-- Index / Landing Page -->
    <section id="page-index" class="grid two" aria-label="Welcome section">
      <div class="card">
        <h2>Welcome to MakiwaFreight</h2>
        <p class="muted">A simple marketplace where shippers meet transporters.</p>
        <div id="indexBanner" class="banner hidden" role="alert"></div>
        <div class="grid two" style="margin-top:12px">
          <a class="btn primary" href="#login">Login</a>
          <a class="btn" href="#register-options">Register</a>
        </div>
        <div style="margin-top:12px" class="muted">
          <strong>Admin access:</strong> <span class="chip">cyprianmak@gmail.com / Muchandida@1</span>
        </div>
      </div>
      <div class="grid three">
        <div class="card"><h3>For Shippers</h3><p>Post loads, manage offers, and message carriers.</p></div>
        <div class="card"><h3>For Transporters</h3><p>Browse the live load board and message shippers.</p></div>
        <div class="card"><h3>Secure & Simple</h3><p>Role-based access with client-side storage for demo use.</p></div>
      </div>
    </section>

    <!-- Register options -->
    <section id="page-register-options" class="card hidden" aria-label="Registration options">
      <h2>Register</h2>
      <div class="grid two">
        <a class="btn" href="#register-shipper">Register as Shipper</a>
        <a class="btn" href="#register-transporter">Register as Transporter</a>
      </div>
    </section>

    <!-- Login -->
    <section id="page-login" class="card hidden" aria-label="Login form">
      <h2>Login</h2>
      <form id="formLogin" novalidate>
        <div class="grid two">
          <div>
            <label for="loginEmail">Email</label>
            <input required type="email" id="loginEmail" name="email" placeholder="you@example.com" autocomplete="email" />
          </div>
          <div>
            <label for="loginPassword">Password</label>
            <input required type="password" id="loginPassword" name="password" placeholder="••••••••" autocomplete="current-password" />
          </div>
        </div>
        <div class="toolbar" style="margin-top:12px">
          <button class="btn primary" type="submit">Sign in</button>
          <a class="btn" href="#register-options">Need an account?</a>
        </div>
      </form>
    </section>

    <!-- Shipper Registration -->
    <section id="page-register-shipper" class="card hidden" aria-label="Shipper registration form">
      <h2>Create Shipper Account</h2>
      <form id="formRegShipper" autocomplete="off" novalidate>
        <div class="grid two">
          <div><label for="shipperName">Full Name</label><input required id="shipperName" name="name" autocomplete="name" /></div>
          <div><label for="shipperCompany">Company</label><input id="shipperCompany" name="company" autocomplete="organization" /></div>
          <div><label for="shipperEmail">Email</label><input required type="email" id="shipperEmail" name="email" autocomplete="email" /></div>
          <div><label for="shipperPhone">Phone</label><input required id="shipperPhone" name="phone" autocomplete="tel" /></div>
          <div><label for="shipperPassword">Password</label><input required type="password" id="shipperPassword" name="password" autocomplete="new-password" /></div>
          <div><label for="shipperAddress">Address</label><input id="shipperAddress" name="address" autocomplete="street-address" /></div>
        </div>
        <div class="toolbar" style="margin-top:12px">
          <button class="btn primary" type="submit">Register</button>
          <a class="btn" href="#login">Back to Login</a>
        </div>
      </form>
    </section>

    <!-- Transporter Registration -->
    <section id="page-register-transporter" class="card hidden" aria-label="Transporter registration form">
      <h2>Create Transporter Account</h2>
      <form id="formRegTransporter" autocomplete="off" novalidate>
        <div class="grid two">
          <div><label for="transporterName">Full Name</label><input required id="transporterName" name="name" autocomplete="name" /></div>
          <div><label for="transporterCompany">Company / Fleet</label><input id="transporterCompany" name="company" autocomplete="organization" /></div>
          <div><label for="transporterEmail">Email</label><input required type="email" id="transporterEmail" name="email" autocomplete="email" /></div>
          <div><label for="transporterPhone">Phone</label><input required id="transporterPhone" name="phone" autocomplete="tel" /></div>
          <div><label for="transporterVehicle">Vehicle Info</label><input id="transporterVehicle" name="vehicle_info" placeholder="e.g. 2 x 34T Side Tipper" /></div>
          <div><label for="transporterPassword">Password</label><input required type="password" id="transporterPassword" name="password" autocomplete="new-password" /></div>
          <div class="two" style="grid-column:1/-1"><label for="transporterAddress">Address</label><input id="transporterAddress" name="address" autocomplete="street-address" /></div>
        </div>
        <div class="toolbar" style="margin-top:12px">
          <button class="btn primary" type="submit">Register</button>
          <a class="btn" href="#login">Back to Login</a>
        </div>
      </form>
    </section>

    <!-- Shipper Dashboard -->
    <section id="page-shipper-dashboard" class="hidden" aria-label="Shipper dashboard">
      <div class="toolbar">
        <h2>Shipper Dashboard</h2>
        <div>
          <a class="btn" href="#shipper-post">Post Load</a>
          <a class="btn" href="#market">Market</a>
          <a class="btn" href="#shipper-profile">Profile</a>
          <a class="btn" href="#messages">Messages</a>
        </div>
      </div>
      <div id="dashBannerShipper" class="banner hidden" role="alert"></div>
      <div class="card">
        <div class="toolbar">
          <h3>Your Posted Loads</h3>
          <span class="chip" id="shipperPostAccessChip" role="status"></span>
        </div>
        <div class="table-container" style="overflow-x:auto">
          <table id="tableMyLoads" aria-label="Your posted loads"><thead><tr>
            <th scope="col">Ref</th><th scope="col">Origin</th><th scope="col">Destination</th><th scope="col">Date</th><th scope="col">Expires</th><th scope="col">Cargo</th><th scope="col">Weight</th><th scope="col">Notes</th><th scope="col">Actions</th>
          </tr></thead><tbody></tbody></table>
        </div>
      </div>
    </section>

    <!-- Shipper Post Load -->
    <section id="page-shipper-post" class="card hidden" aria-label="Post a load form">
      <h2>Post a Load</h2>
      <div id="postAccessNotice" class="banner hidden" role="alert"></div>
      <form id="formPostLoad" novalidate>
        <div class="grid two">
          <div><label for="loadOrigin">Origin</label><input required id="loadOrigin" name="origin" /></div>
          <div><label for="loadDestination">Destination</label><input required id="loadDestination" name="destination" /></div>
          <div><label for="loadDate">Pickup Date</label><input required type="date" id="loadDate" name="date" /></div>
          <div><label for="loadCargo">Cargo Type</label><input required id="loadCargo" name="cargo_type" /></div>
          <div><label for="loadWeight">Weight (Tons)</label><input required id="loadWeight" name="weight" type="number" min="0" step="0.01" /></div>
          <div class="two" style="grid-column:1/-1"><label for="loadNotes">Notes</label><textarea id="loadNotes" name="notes" rows="3"></textarea></div>
        </div>
        <div class="toolbar" style="margin-top:12px">
          <button class="btn primary" type="submit">Publish</button>
          <a class="btn" href="#shipper-dashboard">Back</a>
        </div>
      </form>
    </section>

    <!-- Shipper Profile -->
    <section id="page-shipper-profile" class="card hidden" aria-label="Shipper profile">
      <div class="profile-header">
        <div class="profile-avatar" id="shipperProfileAvatar">S</div>
        <div class="profile-info">
          <h2 id="shipperProfileName">Shipper Name</h2>
          <p class="muted"><span class="status-indicator status-active"></span>Active since <span id="shipperProfileSince">January 2023</span></p>
        </div>
      </div>
      <form id="formProfileShipper" novalidate></form>
      <div class="toolbar" style="margin-top:12px">
        <button class="btn primary" id="saveProfileShipper">Save Changes</button>
        <a class="btn" href="#shipper-dashboard">Back</a>
      </div>
    </section>

    <!-- Transporter Dashboard (Load Board) -->
    <section id="page-transporter-dashboard" class="hidden" aria-label="Transporter dashboard">
      <div class="toolbar">
        <h2>Transporter Dashboard</h2>
        <div>
          <a class="btn" href="#market">Market</a>
          <a class="btn" href="#transporter-profile">Profile</a>
          <a class="btn" href="#messages">Messages</a>
        </div>
      </div>
      <div id="dashBannerTransporter" class="banner hidden" role="alert"></div>
      <div class="card">
        <div class="toolbar">
          <h3>Load Market Board</h3>
          <span class="chip" id="marketAccessChip" role="status"></span>
          <div style="display:flex;gap:8px">
            <input id="filterOrigin" placeholder="Filter by origin" aria-label="Filter by origin" />
            <input id="filterDest" placeholder="Filter by destination" aria-label="Filter by destination" />
            <button id="btnFilterLoads" class="btn">Filter</button>
          </div>
        </div>
        <div class="table-container" style="overflow-x:auto">
          <table id="tableLoads" aria-label="Load market board"><thead><tr>
            <th scope="col">Ref</th><th scope="col">Origin</th><th scope="col">Destination</th><th scope="col">Date</th><th scope="col">Expires</th><th scope="col">Cargo</th><th scope="col">Weight</th><th scope="col">Notes</th><th scope="col">Posted By</th>
          </tr></thead><tbody></tbody></table>
        </div>
      </div>
    </section>

    <!-- Transporter Profile -->
    <section id="page-transporter-profile" class="card hidden" aria-label="Transporter profile">
      <div class="profile-header">
        <div class="profile-avatar" id="transporterProfileAvatar">T</div>
        <div class="profile-info">
          <h2 id="transporterProfileName">Transporter Name</h2>
          <p class="muted"><span class="status-indicator status-active"></span>Active since <span id="transporterProfileSince">January 2023</span></p>
        </div>
      </div>
      <form id="formProfileTransporter" novalidate></form>
      <div class="toolbar" style="margin-top:12px">
        <button class="btn primary" id="saveProfileTransporter">Save Changes</button>
        <a class="btn" href="#transporter-dashboard">Back</a>
      </div>
    </section>

    <!-- Market Page -->
    <section id="page-market" class="hidden" aria-label="Market">
      <div class="toolbar">
        <h2>Load Market</h2>
        <div>
          <a class="btn" href="#messages">Messages</a>
        </div>
      </div>
      <div id="marketBanner" class="banner hidden" role="alert"></div>
      <div class="card">
        <div class="toolbar">
          <h3>Available Loads</h3>
          <div style="display:flex;gap:8px">
            <input id="marketFilterOrigin" placeholder="Filter by origin" aria-label="Filter by origin" />
            <input id="marketFilterDest" placeholder="Filter by destination" aria-label="Filter by destination" />
            <button id="btnMarketFilterLoads" class="btn">Filter</button>
          </div>
        </div>
        <div class="table-container" style="overflow-x:auto">
          <table id="tableMarketLoads" aria-label="Market loads"><thead><tr>
            <th scope="col">Ref</th><th scope="col">Origin</th><th scope="col">Destination</th><th scope="col">Date</th><th scope="col">Expires</th><th scope="col">Cargo</th><th scope="col">Weight</th><th scope="col">Notes</th><th scope="col">Posted By</th>
          </tr></thead><tbody></tbody></table>
        </div>
      </div>
    </section>

    <!-- Messages (Common) -->
    <section id="page-messages" class="card hidden" aria-label="Messages">
      <h2>Messages</h2>
      <div class="grid two">
        <form id="formSendMsg" class="card" novalidate>
          <h3>Send a Message</h3>
          <div class="grid two">
            <div><label for="msgTo">To (email)</label><input required id="msgTo" name="to" placeholder="receiver@example.com" type="email" /></div>
            <div><label for="msgBody">Message</label><input required id="msgBody" name="body" placeholder="Type your message..." /></div>
          </div>
          <div class="toolbar" style="margin-top:12px">
            <button class="btn primary" type="submit">Send</button>
            <a class="btn" href="#">Back</a>
          </div>
        </form>
        <div class="card">
          <h3>Inbox</h3>
          <div class="table-container" style="overflow-x:auto">
            <table id="tableInbox" aria-label="Message inbox"><thead><tr>
              <th scope="col">From</th><th scope="col">Message</th><th scope="col">When</th><th scope="col">Action</th>
            </tr></thead><tbody></tbody></table>
          </div>
        </div>
      </div>
    </section>

    <!-- Admin Control Page -->
    <section id="page-control" class="hidden" aria-label="Admin control panel">
      <div class="toolbar">
        <h2>Admin Control</h2>
        <div>
          <a class="btn" href="#messages">Messages</a>
        </div>
      </div>
      <div class="grid two">
        <div class="card">
          <h3>Broadcasts</h3>
          <label for="adminIndexBanner">Index Banner</label>
          <input id="adminIndexBanner" placeholder="Short notice shown on Index" />
          <label for="adminDashBanner" style="margin-top:8px">Dashboard Banner</label>
          <input id="adminDashBanner" placeholder="Shown on all dashboards" />
          <div class="toolbar" style="margin-top:12px">
            <button id="btnSaveBanners" class="btn primary">Save</button>
            <button id="btnClearBanners" class="btn">Clear</button>
          </div>
        </div>
        <div class="card">
          <h3>Access Controls</h3>
          <div class="grid two">
            <div>
              <label for="aclPostEmail">Post Load access (by user email)</label>
              <input id="aclPostEmail" placeholder="user@example.com" type="email" />
              <div class="toolbar" style="margin-top:8px">
                <button id="btnGrantPost" class="btn">Grant</button>
                <button id="btnRevokePost" class="btn">Revoke</button>
              </div>
            </div>
            <div>
              <label for="aclMarketEmail">Load Market access (by user email)</label>
              <input id="aclMarketEmail" placeholder="user@example.com" type="email" />
              <div class="toolbar" style="margin-top:8px">
                <button id="btnGrantMarket" class="btn">Grant</button>
                <button id="btnRevokeMarket" class="btn">Revoke</button>
              </div>
            </div>
          </div>
        </div>
        <div class="card">
          <h3>Page Access Control</h3>
          <label for="pageAccessUser">Select User</label>
          <select id="pageAccessUser">
            <option value="">-- Select User --</option>
          </select>
          <div id="pageAccessCheckboxes" class="checkbox-group"></div>
          <div class="toolbar" style="margin-top:12px">
            <button id="btnSavePageAccess" class="btn primary">Save Access</button>
          </div>
        </div>
        <div class="card">
          <h3>Users</h3>
          <div class="table-container" style="overflow-x:auto">
            <table id="tableUsers" aria-label="User management"><thead><tr>
              <th scope="col">Name</th><th scope="col">Email</th><th scope="col">Role</th><th scope="col">Actions</th>
            </tr></thead><tbody></tbody></table>
          </div>
        </div>
        <div class="card">
          <h3>Loads</h3>
          <div class="table-container" style="overflow-x:auto">
            <table id="tableAllLoads" aria-label="Load management"><thead><tr>
              <th scope="col">Ref</th><th scope="col">Origin</th><th scope="col">Destination</th><th scope="col">Date</th><th scope="col">Expires</th><th scope="col">Cargo</th><th scope="col">Weight</th><th scope="col">By</th><th scope="col">Actions</th>
            </tr></thead><tbody></tbody></table>
          </div>
        </div>
        <div class="card">
          <h3>Reset Password</h3>
          <div class="grid two">
            <div><label for="resetEmail">User Email</label><input id="resetEmail" placeholder="user@example.com" type="email" /></div>
            <div><label for="resetPass">New Password</label><input id="resetPass" placeholder="new password" type="password" /></div>
          </div>
          <div class="toolbar" style="margin-top:12px">
            <button id="btnResetPass" class="btn">Assign</button>
          </div>
        </div>
      </div>
    </section>
    <div class="footer">Demo build – data stored locally in your browser. Replace with real API in production.</div>
  </main>
  <script>
    // Production optimizations for MakiwaFreight App
    (function() {
      'use strict';
      
      // Constants
      const DB_KEY = 'makiwa.freight.v1';
      const ADMIN_EMAIL = 'cyprianmak@gmail.com';
      const ADMIN_PASS = 'Muchandida@1';
      const LOAD_EXPIRY_DAYS = 7;
      
      // Page definitions for access control
      const PAGES = {
        'shipper-dashboard': { name: 'Shipper Dashboard', roles: ['shipper'] },
        'shipper-post': { name: 'Post Load', roles: ['shipper'] },
        'shipper-profile': { name: 'Shipper Profile', roles: ['shipper'] },
        'transporter-dashboard': { name: 'Transporter Dashboard', roles: ['transporter'] },
        'transporter-profile': { name: 'Transporter Profile', roles: ['transporter'] },
        'market': { name: 'Market', roles: ['shipper', 'transporter'] },
        'messages': { name: 'Messages', roles: ['shipper', 'transporter'] },
        'control': { name: 'Admin Control', roles: ['admin'] }
      };
      
      // Utility functions
      const now = () => new Date().toISOString();
      const el = id => document.getElementById(id);
      const setText = (id, txt) => { const e = el(id); if(e) e.textContent = txt; };
      const setHidden = (id, hid) => { const e = el(id); if(e) e.classList[hid ? 'add' : 'remove']('hidden'); };
      
      // Sanitize input to prevent XSS
      const sanitize = str => {
        if (!str) return '';
        return str.toString()
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#039;');
      };
      
      // Validate email format
      const isValidEmail = email => {
        const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return re.test(email);
      };
      
      // Error handling wrapper
      const handleError = (fn, fallbackMsg = 'An error occurred') => {
        try {
          return fn();
        } catch (error) {
          console.error('MakiwaFreight Error:', error);
          alert(fallbackMsg + ': ' + error.message);
          return null;
        }
      };
      
      // Calculate expiry date (7 days from now)
      const calculateExpiryDate = () => {
        const expiryDate = new Date();
        expiryDate.setDate(expiryDate.getDate() + LOAD_EXPIRY_DAYS);
        return expiryDate.toISOString();
      };
      
      // Check if a load has expired
      const isLoadExpired = load => {
        if (!load.expires_at) return false;
        return new Date(load.expires_at) < new Date();
      };
      
      // Clean up expired loads
      const cleanupExpiredLoads = () => {
        const nowDate = new Date();
        const expiredCount = DB.loads.filter(load => 
          load.expires_at && new Date(load.expires_at) < nowDate
        ).length;
        
        if (expiredCount > 0) {
          DB.loads = DB.loads.filter(load => 
            !load.expires_at || new Date(load.expires_at) >= nowDate
          );
          saveDB(DB);
          console.log(`Cleaned up ${expiredCount} expired loads`);
        }
      };
      
      // Database operations
      const loadDB = () => {
        try {
          const raw = localStorage.getItem(DB_KEY);
          let db = raw ? JSON.parse(raw) : null;
          
          if (!db) {
            db = {
              users: [],
              loads: [],
              messages: [],
              banners: { index: "", dashboard: "" },
              acl: { 
                post: {}, 
                market: {},
                pages: {} // New structure for page access control
              },
              currentUserId: null,
              seed: true
            };
          }
          
          // Ensure admin exists
          let admin = db.users.find(u => u.email === ADMIN_EMAIL);
          if (!admin) {
            admin = {
              id: crypto.randomUUID(),
              name: 'Admin',
              email: ADMIN_EMAIL,
              phone: '',
              password: ADMIN_PASS,
              role: 'admin',
              company: 'MakiwaFreight',
              vehicle_info: '',
              address: '',
              created_at: now(),
              updated_at: now()
            };
            db.users.push(admin);
            db.acl.post[admin.email] = true;
            db.acl.market[admin.email] = true;
            
            // Initialize page access for admin
            if (!db.acl.pages[admin.email]) {
              db.acl.pages[admin.email] = {};
              // Give admin access to all pages
              Object.keys(PAGES).forEach(pageId => {
                db.acl.pages[admin.email][pageId] = true;
              });
            }
          }
          
          return db;
        } catch (error) {
          console.error('Failed to load database:', error);
          // Return a fresh DB if loading fails
          return {
            users: [],
            loads: [],
            messages: [],
            banners: { index: "", dashboard: "" },
            acl: { 
              post: {}, 
              market: {},
              pages: {}
            },
            currentUserId: null,
            seed: true
          };
        }
      };
      
      const saveDB = db => {
        try {
          localStorage.setItem(DB_KEY, JSON.stringify(db));
        } catch (error) {
          console.error('Failed to save database:', error);
          alert('Failed to save data. Your browser may be in private mode or storage is full.');
        }
      };
      
      // Initialize database
      let DB = loadDB();
      
      // Clean up expired loads on initialization
      cleanupExpiredLoads();
      
      // Router
      const pages = {
        index: 'page-index',
        'register-options': 'page-register-options',
        login: 'page-login',
        'register-shipper': 'page-register-shipper',
        'register-transporter': 'page-register-transporter',
        'shipper-dashboard': 'page-shipper-dashboard',
        'shipper-post': 'page-shipper-post',
        'shipper-profile': 'page-shipper-profile',
        'transporter-dashboard': 'page-transporter-dashboard',
        'transporter-profile': 'page-transporter-profile',
        'market': 'page-market',
        messages: 'page-messages',
        control: 'page-control'
      };
      
      const show = hash => {
        const key = (hash || '#').replace('#', '') || 'index';
        for (const k in pages) {
          const element = el(pages[k]);
          if (element) element.classList.add('hidden');
        }
        const activePage = el(pages[key]);
        if (activePage) {
          activePage.classList.remove('hidden');
          // Set focus to the main heading for accessibility
          const heading = activePage.querySelector('h1, h2');
          if (heading) heading.focus();
        }
        render();
      };
      
      // Auth helpers
      const currentUser = () => DB.users.find(u => u.id === DB.currentUserId) || null;
      
      const login = (email, password) => {
        if (!email || !password) return null;
        
        email = email.trim().toLowerCase();
        const user = DB.users.find(u => u.email.toLowerCase() === email && u.password === password);
        
        if (user) {
          DB.currentUserId = user.id;
          saveDB(DB);
          return user;
        }
        return null;
      };
      
      const logout = () => {
        DB.currentUserId = null;
        saveDB(DB);
        location.hash = '#login';
        render();
      };
      
      // Check if user can access a specific page
      const canAccessPage = (user, pageId) => {
        if (!user) return false;
        
        // Admin can access all pages
        if (isAdmin(user)) return true;
        
        // Check if user has explicit access to this page
        const userPages = DB.acl.pages[user.email];
        if (userPages && userPages[pageId]) {
          return true;
        }
        
        // Check if page is in user's default role pages
        const page = PAGES[pageId];
        if (page && page.roles.includes(user.role)) {
          return true;
        }
        
        return false;
      };
      
      // Registration
      const registerUser = data => {
        // Validate required fields
        if (!data.name || !data.email || !data.password || !data.phone) {
          throw new Error('All required fields must be filled');
        }
        
        if (!isValidEmail(data.email)) {
          throw new Error('Please enter a valid email address');
        }
        
        // Check if email already exists (case insensitive)
        const email = data.email.trim().toLowerCase();
        if (DB.users.find(u => u.email.toLowerCase() === email)) {
          throw new Error('Email already in use');
        }
        
        // Sanitize inputs
        const sanitizedData = {
          name: sanitize(data.name),
          company: sanitize(data.company || ''),
          email: email,
          phone: sanitize(data.phone),
          password: data.password, // Don't sanitize password
          address: sanitize(data.address || ''),
          role: data.role,
          vehicle_info: sanitize(data.vehicle_info || '')
        };
        
        const id = crypto.randomUUID();
        const user = { 
          id, 
          created_at: now(), 
          updated_at: now(), 
          ...sanitizedData 
        };
        
        DB.users.push(user);
        
        // Initialize page access for the user
        if (!DB.acl.pages[user.email]) {
          DB.acl.pages[user.email] = {};
          
          // Grant access to default pages based on role
          Object.keys(PAGES).forEach(pageId => {
            if (PAGES[pageId].roles.includes(data.role)) {
              DB.acl.pages[user.email][pageId] = true;
            }
          });
        }
        
        // Default ACLs: grant post to shippers, market to transporters
        if (user.role === 'shipper') DB.acl.post[user.email] = true;
        if (user.role === 'transporter') DB.acl.market[user.email] = true;
        
        saveDB(DB);
        return user;
      };
      
      // Loads
      const postLoad = (user, payload) => {
        // Validate required fields
        if (!payload.origin || !payload.destination || !payload.date || !payload.cargo_type || !payload.weight) {
          throw new Error('All required fields must be filled');
        }
        
        // Sanitize inputs
        const sanitizedPayload = {
          origin: sanitize(payload.origin),
          destination: sanitize(payload.destination),
          date: payload.date,
          cargo_type: sanitize(payload.cargo_type),
          weight: parseFloat(payload.weight),
          notes: sanitize(payload.notes || '')
        };
        
        const ref = Math.random().toString(36).slice(2, 8).toUpperCase();
        const item = { 
          id: crypto.randomUUID(), 
          ref, 
          shipper_id: user.id, 
          ...sanitizedPayload, 
          created_at: now(), 
          updated_at: now(), 
          status: 'active',
          expires_at: calculateExpiryDate() // Set expiry date to 7 days from now
        };
        
        DB.loads.unshift(item);
        saveDB(DB);
        return item;
      };
      
      const canPost = email => !!DB.acl.post[email];
      const canMarket = email => !!DB.acl.market[email];
      
      // Messages
      const sendMessage = (fromUser, toEmail, body) => {
        if (!toEmail || !body) {
          throw new Error('Recipient and message are required');
        }
        
        if (!isValidEmail(toEmail)) {
          throw new Error('Please enter a valid recipient email');
        }
        
        const to = DB.users.find(u => u.email.toLowerCase() === toEmail.toLowerCase());
        if (!to) throw new Error('Receiver not found');
        
        const sanitizedBody = sanitize(body);
        const msg = { 
          id: crypto.randomUUID(), 
          sender_id: fromUser.id, 
          receiver_id: to.id, 
          body: sanitizedBody, 
          created_at: now() 
        };
        
        DB.messages.unshift(msg);
        saveDB(DB);
        return msg;
      };
      
      const inbox = user => DB.messages.filter(m => m.receiver_id === user.id);
      
      // Admin actions
      const isAdmin = u => u && u.role === 'admin';
      
      // Delete user: also cascade loads/messages owned by user
      const adminDeleteUser = email => {
        if (!email) throw new Error('Email is required');
        
        const u = DB.users.find(x => x.email.toLowerCase() === email.toLowerCase());
        if (!u) throw new Error('User not found');
        
        DB.users = DB.users.filter(x => x.id !== u.id);
        DB.loads = DB.loads.filter(l => l.shipper_id !== u.id);
        DB.messages = DB.messages.filter(m => m.sender_id !== u.id && m.receiver_id !== u.id);
        delete DB.acl.post[email];
        delete DB.acl.market[email];
        delete DB.acl.pages[email];
        
        if (DB.currentUserId === u.id) DB.currentUserId = null;
        saveDB(DB);
      };
      
      const adminResetPassword = (email, newPass) => {
        if (!email || !newPass) throw new Error('Email and password are required');
        
        const u = DB.users.find(x => x.email.toLowerCase() === email.toLowerCase());
        if (!u) throw new Error('User not found');
        
        u.password = newPass;
        u.updated_at = now();
        saveDB(DB);
      };
      
      const adminDeleteLoad = id => {
        if (!id) throw new Error('Load ID is required');
        DB.loads = DB.loads.filter(l => l.id !== id);
        saveDB(DB);
      };
      
      const adminEditLoad = (id, patch) => {
        if (!id) throw new Error('Load ID is required');
        
        const l = DB.loads.find(x => x.id === id);
        if (!l) throw new Error('Load not found');
        
        // Sanitize patch values
        const sanitizedPatch = {};
        for (const key in patch) {
          if (key === 'weight') {
            sanitizedPatch[key] = parseFloat(patch[key]);
          } else {
            sanitizedPatch[key] = sanitize(patch[key]);
          }
        }
        
        Object.assign(l, sanitizedPatch);
        l.updated_at = now();
        saveDB(DB);
      };
      
      // Update page access for a user
      const adminUpdatePageAccess = (email, pageAccess) => {
        if (!email) throw new Error('Email is required');
        
        if (!DB.acl.pages[email]) {
          DB.acl.pages[email] = {};
        }
        
        // Update page access
        Object.keys(pageAccess).forEach(pageId => {
          DB.acl.pages[email][pageId] = pageAccess[pageId];
        });
        
        saveDB(DB);
      };
      
      // Update user profile
      const updateUserProfile = (user, profileData) => {
        if (!user || !profileData) throw new Error('User and profile data are required');
        
        // Sanitize inputs
        const sanitizedData = {};
        for (const key in profileData) {
          if (key === 'password') {
            sanitizedData[key] = profileData[key]; // Don't sanitize password
          } else {
            sanitizedData[key] = sanitize(profileData[key]);
          }
        }
        
        Object.assign(user, sanitizedData, { updated_at: now() });
        saveDB(DB);
        return user;
      };
      
      // Rendering functions
      const renderHeader = () => {
        const u = currentUser();
        setHidden('btnLogout', !u);
        setHidden('btnLoginNav', !!u);
        setText('authUser', u ? `${sanitize(u.name)} · ${u.role}` : '');
        
        const chip = el('roleChip');
        if (u) {
          chip.textContent = u.role.toUpperCase();
          chip.classList.remove('hidden');
        } else {
          chip.classList.add('hidden');
        }
        
        // Render navigation links
        const navLinksContainer = el('navLinks');
        if (navLinksContainer) {
          navLinksContainer.innerHTML = '';
          
          if (u) {
            // Add navigation links based on user access
            Object.keys(PAGES).forEach(pageId => {
              if (canAccessPage(u, pageId)) {
                const link = document.createElement('a');
                link.href = `#${pageId}`;
                link.className = 'btn';
                link.textContent = PAGES[pageId].name;
                navLinksContainer.appendChild(link);
              }
            });
          }
        }
      };
      
      const renderBanners = () => {
        const { index, dashboard } = DB.banners;
        const i = el('indexBanner');
        if (i) {
          i.textContent = sanitize(index) || '';
          setHidden('indexBanner', !index);
        }
        
        const u = currentUser();
        const d1 = el('dashBannerShipper');
        const d2 = el('dashBannerTransporter');
        const m = el('marketBanner');
        
        if (d1) {
          d1.textContent = sanitize(dashboard) || '';
          setHidden('dashBannerShipper', !dashboard);
        }
        
        if (d2) {
          d2.textContent = sanitize(dashboard) || '';
          setHidden('dashBannerTransporter', !dashboard);
        }
        
        if (m) {
          m.textContent = sanitize(dashboard) || '';
          setHidden('marketBanner', !dashboard);
        }
        
        // Preload admin form fields
        if (isAdmin(u)) {
          const adminIndexBanner = el('adminIndexBanner');
          const adminDashBanner = el('adminDashBanner');
          if (adminIndexBanner) adminIndexBanner.value = index || '';
          if (adminDashBanner) adminDashBanner.value = dashboard || '';
        }
      };
      
      const renderShipper = () => {
        const u = currentUser();
        if (!u) return;
        
        // Clean up expired loads before rendering
        cleanupExpiredLoads();
        
        // Post access chip
        const allow = canPost(u.email);
        setText('shipperPostAccessChip', allow ? 'Post access: ENABLED' : 'Post access: DISABLED');
        
        // My loads table
        const rows = DB.loads.filter(l => l.shipper_id === u.id);
        const tb = el('tableMyLoads');
        if (!tb) return;
        
        const tbody = tb.querySelector('tbody');
        if (!tbody) return;
        
        tbody.innerHTML = '';
        
        if (rows.length === 0) {
          const emptyRow = document.createElement('tr');
          emptyRow.innerHTML = '<td colspan="9" style="text-align:center">No loads posted yet</td>';
          tbody.appendChild(emptyRow);
          return;
        }
        
        for (const l of rows) {
          const expired = isLoadExpired(l);
          const expiryDate = l.expires_at ? new Date(l.expires_at).toLocaleDateString() : 'N/A';
          
          const tr = document.createElement('tr');
          if (expired) tr.classList.add('expired');
          
          tr.innerHTML = `
            <td>${sanitize(l.ref)}</td>
            <td>${sanitize(l.origin)}</td>
            <td>${sanitize(l.destination)}</td>
            <td>${sanitize(l.date)}</td>
            <td>${expiryDate}</td>
            <td>${sanitize(l.cargo_type)}</td>
            <td>${sanitize(l.weight)}</td>
            <td>${sanitize(l.notes || '')}</td>
            <td>
              <button class="btn" data-edit="${l.id}" aria-label="Edit load ${l.ref}">Edit</button>
              <button class="btn danger" data-del="${l.id}" aria-label="Delete load ${l.ref}">Delete</button>
            </td>`;
          tbody.appendChild(tr);
        }
        
        // Action handlers
        tbody.querySelectorAll('[data-del]').forEach(b => {
          b.onclick = () => {
            if (confirm('Are you sure you want to delete this load?')) {
              handleError(() => {
                adminDeleteLoad(b.dataset.del);
                render();
              }, 'Failed to delete load');
            }
          };
        });
        
        tbody.querySelectorAll('[data-edit]').forEach(b => {
          b.onclick = () => {
            const l = DB.loads.find(x => x.id === b.dataset.edit);
            if (!l) return;
            
            const origin = prompt('Origin', l.origin);
            if (origin === null) return;
            
            const destination = prompt('Destination', l.destination);
            if (destination === null) return;
            
            const date = prompt('Date (YYYY-MM-DD)', l.date);
            if (date === null) return;
            
            const cargo_type = prompt('Cargo', l.cargo_type);
            if (cargo_type === null) return;
            
            const weight = prompt('Weight', l.weight);
            if (weight === null) return;
            
            const notes = prompt('Notes', l.notes || '');
            if (notes === null) return;
            
            handleError(() => {
              adminEditLoad(l.id, { origin, destination, date, cargo_type, weight, notes });
              render();
            }, 'Failed to update load');
          };
        });
        
        // Post page access notice
        const notice = el('postAccessNotice');
        if (notice) {
          notice.textContent = allow ? '' : 'Admin has disabled your Post Load access.';
          setHidden('postAccessNotice', allow);
        }
      };
      
      const renderTransporter = () => {
        const u = currentUser();
        if (!u) return;
        
        // Clean up expired loads before rendering
        cleanupExpiredLoads();
        
        const allow = canMarket(u.email);
        setText('marketAccessChip', allow ? 'Market access: ENABLED' : 'Market access: DISABLED');
        
        const tb = el('tableLoads');
        if (!tb) return;
        
        const tbody = tb.querySelector('tbody');
        if (!tbody) return;
        
        tbody.innerHTML = '';
        
        // Only show non-expired loads to users with market access
        let rows = allow ? DB.loads.filter(l => !isLoadExpired(l)) : [];
        
        const fo = el('filterOrigin');
        const fd = el('filterDest');
        
        if (fo) rows = rows.filter(l => l.origin.toLowerCase().includes(fo.value.trim().toLowerCase()));
        if (fd) rows = rows.filter(l => l.destination.toLowerCase().includes(fd.value.trim().toLowerCase()));
        
        if (rows.length === 0) {
          const emptyRow = document.createElement('tr');
          emptyRow.innerHTML = '<td colspan="9" style="text-align:center">No loads available</td>';
          tbody.appendChild(emptyRow);
          return;
        }
        
        for (const l of rows) {
          const shipper = DB.users.find(x => x.id === l.shipper_id);
          const expiryDate = l.expires_at ? new Date(l.expires_at).toLocaleDateString() : 'N/A';
          
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${sanitize(l.ref)}</td>
            <td>${sanitize(l.origin)}</td>
            <td>${sanitize(l.destination)}</td>
            <td>${sanitize(l.date)}</td>
            <td>${expiryDate}</td>
            <td>${sanitize(l.cargo_type)}</td>
            <td>${sanitize(l.weight)}</td>
            <td>${sanitize(l.notes || '')}</td>
            <td>${shipper ? sanitize(shipper.email) : ''}</td>`;
          tbody.appendChild(tr);
        }
      };
      
      const renderMarket = () => {
        const u = currentUser();
        if (!u) return;
        
        // Clean up expired loads before rendering
        cleanupExpiredLoads();
        
        // Only show non-expired loads to users with market access
        let rows = canMarket(u.email) ? DB.loads.filter(l => !isLoadExpired(l)) : [];
        
        const fo = el('marketFilterOrigin');
        const fd = el('marketFilterDest');
        
        if (fo) rows = rows.filter(l => l.origin.toLowerCase().includes(fo.value.trim().toLowerCase()));
        if (fd) rows = rows.filter(l => l.destination.toLowerCase().includes(fd.value.trim().toLowerCase()));
        
        const tb = el('tableMarketLoads');
        if (!tb) return;
        
        const tbody = tb.querySelector('tbody');
        if (!tbody) return;
        
        tbody.innerHTML = '';
        
        if (rows.length === 0) {
          const emptyRow = document.createElement('tr');
          emptyRow.innerHTML = '<td colspan="9" style="text-align:center">No loads available</td>';
          tbody.appendChild(emptyRow);
          return;
        }
        
        for (const l of rows) {
          const shipper = DB.users.find(x => x.id === l.shipper_id);
          const expiryDate = l.expires_at ? new Date(l.expires_at).toLocaleDateString() : 'N/A';
          
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${sanitize(l.ref)}</td>
            <td>${sanitize(l.origin)}</td>
            <td>${sanitize(l.destination)}</td>
            <td>${sanitize(l.date)}</td>
            <td>${expiryDate}</td>
            <td>${sanitize(l.cargo_type)}</td>
            <td>${sanitize(l.weight)}</td>
            <td>${sanitize(l.notes || '')}</td>
            <td>${shipper ? sanitize(shipper.email) : ''}</td>`;
          tbody.appendChild(tr);
        }
      };
      
      const renderProfiles = () => {
        const u = currentUser();
        if (!u) return;
        
        // Update profile header
        if (u.role === 'shipper') {
          const avatar = el('shipperProfileAvatar');
          const name = el('shipperProfileName');
          const since = el('shipperProfileSince');
          
          if (avatar) avatar.textContent = u.name.charAt(0).toUpperCase();
          if (name) name.textContent = u.name;
          if (since) since.textContent = new Date(u.created_at).toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
        }
        
        if (u.role === 'transporter') {
          const avatar = el('transporterProfileAvatar');
          const name = el('transporterProfileName');
          const since = el('transporterProfileSince');
          
          if (avatar) avatar.textContent = u.name.charAt(0).toUpperCase();
          if (name) name.textContent = u.name;
          if (since) since.textContent = new Date(u.created_at).toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
        }
        
        const fields = (user, role) => {
          const base = `
            <div class="grid two">
              <div><label for="${role}Name">Full Name</label><input required id="${role}Name" name="name" value="${sanitize(user.name || '')}" /></div>
              <div><label for="${role}Company">Company</label><input id="${role}Company" name="company" value="${sanitize(user.company || '')}" /></div>
              <div><label for="${role}Email">Email</label><input id="${role}Email" name="email" value="${sanitize(user.email || '')}" type="email" readonly /></div>
              <div><label for="${role}Phone">Phone</label><input id="${role}Phone" name="phone" value="${sanitize(user.phone || '')}" /></div>
              ${role === 'transporter' ? `<div class="two" style="grid-column:1/-1"><label for="${role}Vehicle">Vehicle Info</label><input id="${role}Vehicle" name="vehicle_info" value="${sanitize(user.vehicle_info || '')}" /></div>` : ''}
              <div class="two" style="grid-column:1/-1"><label for="${role}Address">Address</label><input id="${role}Address" name="address" value="${sanitize(user.address || '')}" /></div>
              <div><label for="${role}Password">Password</label><input id="${role}Password" name="password" type="password" value="${user.password || ''}" /></div>
              <div><label>Role</label><input disabled value="${sanitize(user.role)}" /></div>
            </div>`;
          return base;
        };
        
        if (u.role === 'shipper') {
          const form = el('formProfileShipper');
          if (form) form.innerHTML = fields(u, 'shipper');
        }
        
        if (u.role === 'transporter') {
          const form = el('formProfileTransporter');
          if (form) form.innerHTML = fields(u, 'transporter');
        }
      };
      
      const renderMessages = () => {
        const u = currentUser();
        if (!u) return;
        
        const tb = el('tableInbox');
        if (!tb) return;
        
        const tbody = tb.querySelector('tbody');
        if (!tbody) return;
        
        tbody.innerHTML = '';
        
        const messages = inbox(u);
        
        if (messages.length === 0) {
          const emptyRow = document.createElement('tr');
          emptyRow.innerHTML = '<td colspan="4" style="text-align:center">No messages</td>';
          tbody.appendChild(emptyRow);
          return;
        }
        
        for (const m of messages) {
          const from = DB.users.find(x => x.id === m.sender_id);
          const tr = document.createElement('tr');
          const d = new Date(m.created_at).toLocaleString();
          tr.innerHTML = `
            <td>${from ? sanitize(from.email) : 'Unknown'}</td>
            <td>${sanitize(m.body)}</td>
            <td>${sanitize(d)}</td>
            <td><button class="btn" data-delmsg="${m.id}" aria-label="Delete message">Delete</button></td>`;
          tbody.appendChild(tr);
        }
        
        tbody.querySelectorAll('[data-delmsg]').forEach(b => {
          b.onclick = () => {
            handleError(() => {
              DB.messages = DB.messages.filter(x => x.id !== b.dataset.delmsg);
              saveDB(DB);
              render();
            }, 'Failed to delete message');
          };
        });
      };
      
      const renderAdmin = () => {
        const u = currentUser();
        if (!isAdmin(u)) return;
        
        // Clean up expired loads before rendering admin panel
        cleanupExpiredLoads();
        
        // Populate user dropdown for page access control
        const userSelect = el('pageAccessUser');
        if (userSelect) {
          userSelect.innerHTML = '<option value="">-- Select User --</option>';
          
          DB.users.forEach(user => {
            if (user.role !== 'admin') { // Exclude admin from the list
              const option = document.createElement('option');
              option.value = user.email;
              option.textContent = `${user.name} (${user.email})`;
              userSelect.appendChild(option);
            }
          });
          
          // Add change event listener
          userSelect.onchange = () => {
            renderPageAccessCheckboxes(userSelect.value);
          };
        }
        
        // Users table
        const tbU = el('tableUsers');
        if (tbU) {
          const tbodyU = tbU.querySelector('tbody');
          if (tbodyU) {
            tbodyU.innerHTML = '';
            
            for (const usr of DB.users) {
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td>${sanitize(usr.name)}</td>
                <td>${sanitize(usr.email)}</td>
                <td>${sanitize(usr.role)}</td>
                <td>
                  <button class="btn" data-grant-post="${usr.email}" aria-label="Grant post access to ${usr.email}">Grant Post</button>
                  <button class="btn" data-revoke-post="${usr.email}" aria-label="Revoke post access from ${usr.email}">Revoke Post</button>
                  <button class="btn" data-grant-market="${usr.email}" aria-label="Grant market access to ${usr.email}">Grant Market</button>
                  <button class="btn" data-revoke-market="${usr.email}" aria-label="Revoke market access from ${usr.email}">Revoke Market</button>
                  <button class="btn danger" data-deluser="${usr.email}" aria-label="Delete user ${usr.email}">Delete</button>
                </td>`;
              tbodyU.appendChild(tr);
            }
            
            tbodyU.querySelectorAll('[data-deluser]').forEach(b => {
              b.onclick = () => {
                if (confirm('Are you sure you want to delete this user? This will also delete all their associated data.')) {
                  handleError(() => {
                    adminDeleteUser(b.dataset.deluser);
                    render();
                  }, 'Failed to delete user');
                }
              };
            });
            
            tbodyU.querySelectorAll('[data-grant-post]').forEach(b => {
              b.onclick = () => {
                DB.acl.post[b.dataset.grantPost] = true;
                saveDB(DB);
                render();
              };
            });
            
            tbodyU.querySelectorAll('[data-revoke-post]').forEach(b => {
              b.onclick = () => {
                delete DB.acl.post[b.dataset.revokePost];
                saveDB(DB);
                render();
              };
            });
            
            tbodyU.querySelectorAll('[data-grant-market]').forEach(b => {
              b.onclick = () => {
                DB.acl.market[b.dataset.grantMarket] = true;
                saveDB(DB);
                render();
              };
            });
            
            tbodyU.querySelectorAll('[data-revoke-market]').forEach(b => {
              b.onclick = () => {
                delete DB.acl.market[b.dataset.revokeMarket];
                saveDB(DB);
                render();
              };
            });
          }
        }
        
        // Loads table
        const tbL = el('tableAllLoads');
        if (tbL) {
          const tbodyL = tbL.querySelector('tbody');
          if (tbodyL) {
            tbodyL.innerHTML = '';
            
            for (const l of DB.loads) {
              const by = DB.users.find(x => x.id === l.shipper_id);
              const expired = isLoadExpired(l);
              const expiryDate = l.expires_at ? new Date(l.expires_at).toLocaleDateString() : 'N/A';
              
              const tr = document.createElement('tr');
              if (expired) tr.classList.add('expired');
              
              tr.innerHTML = `
                <td>${sanitize(l.ref)}</td>
                <td>${sanitize(l.origin)}</td>
                <td>${sanitize(l.destination)}</td>
                <td>${sanitize(l.date)}</td>
                <td>${expiryDate}</td>
                <td>${sanitize(l.cargo_type)}</td>
                <td>${sanitize(l.weight)}</td>
                <td>${by ? sanitize(by.email) : ''}</td>
                <td>
                  <button class="btn" data-editl="${l.id}" aria-label="Edit load ${l.ref}">Edit</button>
                  <button class="btn danger" data-dell="${l.id}" aria-label="Delete load ${l.ref}">Delete</button>
                </td>`;
              tbodyL.appendChild(tr);
            }
            
            tbodyL.querySelectorAll('[data-dell]').forEach(b => {
              b.onclick = () => {
                if (confirm('Are you sure you want to delete this load?')) {
                  handleError(() => {
                    adminDeleteLoad(b.dataset.dell);
                    render();
                  }, 'Failed to delete load');
                }
              };
            });
            
            tbodyL.querySelectorAll('[data-editl]').forEach(b => {
              b.onclick = () => {
                const l = DB.loads.find(x => x.id === b.dataset.editl);
                if (!l) return;
                
                const origin = prompt('Origin', l.origin);
                if (origin === null) return;
                
                const destination = prompt('Destination', l.destination);
                if (destination === null) return;
                
                const date = prompt('Date (YYYY-MM-DD)', l.date);
                if (date === null) return;
                
                const cargo_type = prompt('Cargo', l.cargo_type);
                if (cargo_type === null) return;
                
                const weight = prompt('Weight', l.weight);
                if (weight === null) return;
                
                const notes = prompt('Notes', l.notes || '');
                if (notes === null) return;
                
                handleError(() => {
                  adminEditLoad(l.id, { origin, destination, date, cargo_type, weight, notes });
                  render();
                }, 'Failed to update load');
              };
            });
          }
        }
      };
      
      // Render page access checkboxes for a specific user
      const renderPageAccessCheckboxes = (email) => {
        const container = el('pageAccessCheckboxes');
        if (!container || !email) {
          container.innerHTML = '';
          return;
        }
        
        container.innerHTML = '';
        
        // Get current page access for this user
        const userPages = DB.acl.pages[email] || {};
        
        // Create checkboxes for each page
        Object.keys(PAGES).forEach(pageId => {
          // Skip admin control page for non-admin users
          if (pageId === 'control') return;
          
          const checkboxItem = document.createElement('div');
          checkboxItem.className = 'checkbox-item';
          
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.id = `page_${pageId}`;
          checkbox.value = pageId;
          checkbox.checked = !!userPages[pageId];
          
          const label = document.createElement('label');
          label.htmlFor = `page_${pageId}`;
          label.textContent = PAGES[pageId].name;
          
          checkboxItem.appendChild(checkbox);
          checkboxItem.appendChild(label);
          container.appendChild(checkboxItem);
        });
      };
      
      const render = () => {
        renderHeader();
        renderBanners();
        
        const u = currentUser();
        
        // Auth guard: if on restricted page and not logged in -> login
        const restricted = ['shipper-dashboard', 'shipper-post', 'shipper-profile', 'transporter-dashboard', 'transporter-profile', 'market', 'messages', 'control'];
        const page = (location.hash || '#').replace('#', '') || 'index';
        
        if (!u && restricted.includes(page)) {
          location.hash = '#login';
          return;
        }
        
        // Check if user has access to the current page
        if (u && !canAccessPage(u, page)) {
          // If the user is an admin, they can access everything, so this shouldn't happen.
          // For non-admin, redirect to their role's dashboard or index?
          if (u.role === 'shipper') {
            location.hash = '#shipper-dashboard';
          } else if (u.role === 'transporter') {
            location.hash = '#transporter-dashboard';
          } else {
            location.hash = '#index';
          }
          return;
        }
        
        if (u) {
          // Role routing
          if (page === 'index') {
            if (u.role === 'shipper') location.hash = '#shipper-dashboard';
            else if (u.role === 'transporter') location.hash = '#transporter-dashboard';
            else if (isAdmin(u)) location.hash = '#control';
          }
          
          if (page.startsWith('shipper')) renderShipper();
          if (page.startsWith('transporter')) renderTransporter();
          if (page === 'market') renderMarket();
          if (page === 'messages') renderMessages();
          if (page === 'shipper-profile' || page === 'transporter-profile') renderProfiles();
          if (page === 'control') {
            if (!isAdmin(u)) {
              location.hash = '#login';
              return;
            }
            renderAdmin();
          }
        }
      };
      
      // Event bindings
      const initEventListeners = () => {
        // Logout
        const btnLogout = el('btnLogout');
        if (btnLogout) btnLogout.onclick = logout;
        
        // Login form
        const formLogin = el('formLogin');
        if (formLogin) {
          formLogin.onsubmit = e => {
            e.preventDefault();
            const fd = new FormData(e.target);
            const email = fd.get('email');
            const password = fd.get('password');
            
            if (!email || !password) {
              alert('Please enter both email and password');
              return;
            }
            
            const user = login(email, password);
            if (!user) {
              alert('Invalid credentials');
              return;
            }
            
            if (user.role === 'shipper') location.hash = '#shipper-dashboard';
            else if (user.role === 'transporter') location.hash = '#transporter-dashboard';
            else if (isAdmin(user)) location.hash = '#control';
          };
        }
        
        // Shipper registration form
        const formRegShipper = el('formRegShipper');
        if (formRegShipper) {
          formRegShipper.onsubmit = e => {
            e.preventDefault();
            const fd = new FormData(e.target);
            
            handleError(() => {
              registerUser({
                name: fd.get('name'),
                company: fd.get('company'),
                email: fd.get('email'),
                phone: fd.get('phone'),
                password: fd.get('password'),
                address: fd.get('address'),
                role: 'shipper'
              });
              alert('Shipper registered. Please login.');
              location.hash = '#login';
            }, 'Registration failed');
          };
        }
        
        // Transporter registration form
        const formRegTransporter = el('formRegTransporter');
        if (formRegTransporter) {
          formRegTransporter.onsubmit = e => {
            e.preventDefault();
            const fd = new FormData(e.target);
            
            handleError(() => {
              registerUser({
                name: fd.get('name'),
                company: fd.get('company'),
                email: fd.get('email'),
                phone: fd.get('phone'),
                password: fd.get('password'),
                address: fd.get('address'),
                vehicle_info: fd.get('vehicle_info'),
                role: 'transporter'
              });
              alert('Transporter registered. Please login.');
              location.hash = '#login';
            }, 'Registration failed');
          };
        }
        
        // Post load form
        const formPostLoad = el('formPostLoad');
        if (formPostLoad) {
          formPostLoad.onsubmit = e => {
            e.preventDefault();
            const fd = new FormData(e.target);
            const u = currentUser();
            
            if (!canPost(u.email)) {
              alert('Your Post Load access is disabled by Admin.');
              return;
            }
            
            handleError(() => {
              postLoad(u, {
                origin: fd.get('origin'),
                destination: fd.get('destination'),
                date: fd.get('date'),
                cargo_type: fd.get('cargo_type'),
                weight: fd.get('weight'),
                notes: fd.get('notes')
              });
              alert('Load published successfully. It will expire in 7 days.');
              e.target.reset();
              location.hash = '#shipper-dashboard';
            }, 'Failed to post load');
          };
        }
        
        // Save shipper profile
        const saveProfileShipper = el('saveProfileShipper');
        if (saveProfileShipper) {
          saveProfileShipper.onclick = () => {
            const u = currentUser();
            if (!u) return;
            
            const f = el('formProfileShipper');
            if (!f) return;
            
            handleError(() => {
              const data = Object.fromEntries(new FormData(f).entries());
              updateUserProfile(u, data);
              alert('Profile updated successfully');
              render();
            }, 'Failed to save profile');
          };
        }
        
        // Save transporter profile
        const saveProfileTransporter = el('saveProfileTransporter');
        if (saveProfileTransporter) {
          saveProfileTransporter.onclick = () => {
            const u = currentUser();
            if (!u) return;
            
            const f = el('formProfileTransporter');
            if (!f) return;
            
            handleError(() => {
              const data = Object.fromEntries(new FormData(f).entries());
              updateUserProfile(u, data);
              alert('Profile updated successfully');
              render();
            }, 'Failed to save profile');
          };
        }
        
        // Filter loads
        const btnFilterLoads = el('btnFilterLoads');
        if (btnFilterLoads) {
          btnFilterLoads.onclick = e => {
            e.preventDefault();
            renderTransporter();
          };
        }
        
        // Filter market loads
        const btnMarketFilterLoads = el('btnMarketFilterLoads');
        if (btnMarketFilterLoads) {
          btnMarketFilterLoads.onclick = e => {
            e.preventDefault();
            renderMarket();
          };
        }
        
        // Send message form
        const formSendMsg = el('formSendMsg');
        if (formSendMsg) {
          formSendMsg.onsubmit = e => {
            e.preventDefault();
            const fd = new FormData(e.target);
            const u = currentUser();
            
            handleError(() => {
              sendMessage(u, fd.get('to').trim(), fd.get('body').trim());
              e.target.reset();
              renderMessages();
            }, 'Failed to send message');
          };
        }
        
        // Admin controls
        const btnSaveBanners = el('btnSaveBanners');
        if (btnSaveBanners) {
          btnSaveBanners.onclick = () => {
            DB.banners.index = el('adminIndexBanner').value || '';
            DB.banners.dashboard = el('adminDashBanner').value || '';
            saveDB(DB);
            render();
          };
        }
        
        const btnClearBanners = el('btnClearBanners');
        if (btnClearBanners) {
          btnClearBanners.onclick = () => {
            DB.banners.index = '';
            DB.banners.dashboard = '';
            saveDB(DB);
            render();
          };
        }
        
        const btnGrantPost = el('btnGrantPost');
        if (btnGrantPost) {
          btnGrantPost.onclick = () => {
            const email = el('aclPostEmail').value.trim();
            if (email) {
              DB.acl.post[email] = true;
              saveDB(DB);
              render();
            }
          };
        }
        
        const btnRevokePost = el('btnRevokePost');
        if (btnRevokePost) {
          btnRevokePost.onclick = () => {
            const email = el('aclPostEmail').value.trim();
            if (email) {
              delete DB.acl.post[email];
              saveDB(DB);
              render();
            }
          };
        }
        
        const btnGrantMarket = el('btnGrantMarket');
        if (btnGrantMarket) {
          btnGrantMarket.onclick = () => {
            const email = el('aclMarketEmail').value.trim();
            if (email) {
              DB.acl.market[email] = true;
              saveDB(DB);
              render();
            }
          };
        }
        
        const btnRevokeMarket = el('btnRevokeMarket');
        if (btnRevokeMarket) {
          btnRevokeMarket.onclick = () => {
            const email = el('aclMarketEmail').value.trim();
            if (email) {
              delete DB.acl.market[email];
              saveDB(DB);
              render();
            }
          };
        }
        
        const btnResetPass = el('btnResetPass');
        if (btnResetPass) {
          btnResetPass.onclick = () => {
            const email = el('resetEmail').value.trim();
            const p = el('resetPass').value;
            
            handleError(() => {
              adminResetPassword(email, p);
              alert('Password updated');
            }, 'Failed to reset password');
          };
        }
        
        // Save page access
        const btnSavePageAccess = el('btnSavePageAccess');
        if (btnSavePageAccess) {
          btnSavePageAccess.onclick = () => {
            const email = el('pageAccessUser').value;
            if (!email) {
              alert('Please select a user');
              return;
            }
            
            const pageAccess = {};
            const checkboxes = el('pageAccessCheckboxes').querySelectorAll('input[type="checkbox"]');
            
            checkboxes.forEach(checkbox => {
              pageAccess[checkbox.value] = checkbox.checked;
            });
            
            handleError(() => {
              adminUpdatePageAccess(email, pageAccess);
              alert('Page access updated successfully');
            }, 'Failed to update page access');
          };
        }
        
        // Top nav buttons
        const btnLoginNav = el('btnLoginNav');
        if (btnLoginNav) {
          btnLoginNav.onclick = () => {
            location.hash = '#login';
          };
        }
      };
      
      // Initialize the app
      const init = () => {
        // Set up hash change listener
        window.addEventListener('hashchange', () => show(location.hash));
        
        // Initialize event listeners
        initEventListeners();
        
        // Initial render
        show(location.hash);
        
        // Add error handler for uncaught errors
        window.addEventListener('error', event => {
          console.error('Uncaught error:', event.error);
          // Prevent default error handling
          event.preventDefault();
        });
      };
      
      // Start the app when DOM is ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }
    })();
  </script>
</body>
</html>
